<!DOCTYPE html>  <html> <head>   <title>file.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="brewfile.html">                 brewfile.coffee               </a>                                           <a class="source" href="command.html">                 command.coffee               </a>                                           <a class="source" href="file.html">                 file.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="package.html">                 package.coffee               </a>                                           <a class="source" href="coffee-script.html">                 coffee-script.coffee               </a>                                           <a class="source" href="css.html">                 css.coffee               </a>                                           <a class="source" href="javascript.html">                 javascript.coffee               </a>                                           <a class="source" href="less.html">                 less.coffee               </a>                                           <a class="source" href="stylus.html">                 stylus.coffee               </a>                                           <a class="source" href="project.html">                 project.coffee               </a>                                           <a class="source" href="source.html">                 source.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               file.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>The File class</h2>

<p>This module exports the <em>File</em> class, which wraps all
information about a file: </p>

<ul>
<li>Its access path and full path</li>
<li>Its type (<em>javascript, css, less, etc.</em>)</li>
<li>Its associated <em><a href="source.html">Source</a></em> and <em><a href="package.html">Package</a></em> objects</li>
</ul>

<p>It also holds all logic related to maintaining and interacting 
with the files on disk.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>First import core modules, as well as third-party modules and
cli utilities.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">path  = </span><span class="nx">require</span> <span class="s1">&#39;path&#39;</span>
<span class="nv">util  = </span><span class="nx">require</span> <span class="s1">&#39;./util&#39;</span>
<span class="nv">fs    = </span><span class="nx">require</span> <span class="s1">&#39;fs&#39;</span>
<span class="p">{</span><span class="nx">EventEmitter</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;events&#39;</span>

<span class="nv">_ = </span><span class="nx">require</span> <span class="s1">&#39;underscore&#39;</span>
<span class="p">{</span><span class="nx">finished</span><span class="p">,</span> <span class="nx">debug</span><span class="p">,</span> <span class="nx">info</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./command&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Initialization</h3>

<p>A <em>File</em> object is initialized with an access path, a type
and a <em>Package</em> object. At this point, it cannot interact with
the filesystem, because it does not know what the fullpath is
(it might not even exist!).</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">File</span> <span class="k">extends</span> <span class="nx">EventEmitter</span>
  <span class="nv">constructor: </span><span class="nf">(@relpath, @type, @package) -&gt;</span>
    <span class="vi">@dependencies = </span><span class="p">[]</span>
    <span class="vi">@liabilities = </span><span class="p">[]</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>This method associates a file with a fullpath and
a <em>Source</em> object. At this point, it can interact with the
filesystem. It is used first to detect if a file is attached
twice (which shouldn't happen), and to trigger listeners, which
might have been waiting for the file to be attached. This happens
when a file references another one, that does not exist yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attach: </span><span class="nf">(fullpath, source) -&gt;</span>
    <span class="k">if</span> <span class="nx">@attached</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">fullpath</span> <span class="o">isnt</span> <span class="nx">@fullpath</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;File already attached to #{@fullpath}&quot;</span>
    <span class="k">else</span>
      <span class="p">[</span><span class="nx">@fullpath</span><span class="p">,</span> <span class="nx">@source</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">fullpath</span><span class="p">,</span> <span class="nx">source</span><span class="p">]</span>
      <span class="nx">@emit</span> <span class="s1">&#39;attach&#39;</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>This method tells the associated <em>Package</em> object to
register this file, a mechanism required so the package can 
adequately manage all its contained files.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">register: </span><span class="o">-&gt;</span>
    <span class="nx">@package</span><span class="p">.</span><span class="nx">emit</span> <span class="s1">&#39;newfile&#39;</span><span class="p">,</span> <span class="k">this</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>Output methods</h3>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This method is used to actualize a file relative to its 
dependencies. It takes a continuation callback as sole argument.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">actualize: </span><span class="nf">(cb) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>It first loops through all dependencies, telling each to actualize in 
turn. This is done asynchronously, so we wait for each one to finish before 
continuing to the next. When all are actualized, we call the <code>end()</code> method, 
below. It should be noticed that this is a 
<em><a href="http://en.wikipedia.org/wiki/Depth-first_search">depth-first</a></em>-type 
algorithm.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">i = </span><span class="mi">0</span>
    <span class="nv">iter = </span><span class="p">()</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">@dependencies</span><span class="p">.</span><span class="nx">length</span>
        <span class="p">[</span><span class="nx">dep</span><span class="p">,</span> <span class="nx">act</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@dependencies</span><span class="p">[</span><span class="nx">i</span><span class="o">++</span><span class="p">]</span>
        <span class="nx">dep</span><span class="p">.</span><span class="nx">actualize</span> <span class="o">-&gt;</span> <span class="nx">iter</span><span class="p">()</span>
      <span class="k">else</span> <span class="nx">end</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>When all dependencies are actualized, we, again, loop through all of them
comparing its modification time with this file. In case a given dependency is 
newer, we trigger the associated actualization function, given earlier 
through <code>dependOn(..)</code>. At the end of the loop, if the file is still considered
newest, we trigger the continuation callback, otherwise it will be called at
the end of the actualization.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">end = </span><span class="p">()</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">@dependencies</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nv">newest = </span><span class="kc">true</span>
        <span class="k">for</span> <span class="p">[</span><span class="nx">dep</span><span class="p">,</span> <span class="nx">act</span><span class="p">]</span> <span class="k">in</span> <span class="nx">@dependencies</span>
          <span class="nx">unless</span> <span class="nx">@newer</span> <span class="nx">dep</span>
            <span class="nx">act</span> <span class="nx">dep</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
              <span class="nx">cb</span><span class="p">()</span>
            
            <span class="nv">newest = </span><span class="kc">false</span>
            <span class="k">break</span>
        <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">newest</span>
      <span class="k">else</span> <span class="nx">cb</span><span class="p">()</span>
    
    <span class="nx">iter</span><span class="p">()</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This method is used to apply a transformation (<em>morph</em>) to this file 
and output the result in another (<em>dest</em>). It also takes a 
continuation callback as its last argument.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">project: </span><span class="nf">(dest, morph, cb) -&gt;</span>  
    <span class="nx">@read</span> <span class="nf">(err, data) -&gt;</span>
      <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nx">morph</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(error, newdata) -&gt;</span>
        <span class="nx">dest</span><span class="p">.</span><span class="nx">write</span> <span class="nx">newdata</span><span class="p">,</span> <span class="nx">cb</span>
      
    
  
  </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>This method is used to watch the file on the filesystem, which 
should only happend if the file is attached and has liabilities. 
It takes a reset function as sole argument, which is called when 
a change happens.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">watch: </span><span class="nf">(reset) -&gt;</span>
    <span class="k">if</span> <span class="nx">@attached</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@liabilities</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>If the file has an associated source that should not be 
watched for changes, then the file should not be watched.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">unless</span> <span class="o">!</span><span class="nx">@source</span><span class="o">?</span> <span class="o">or</span> <span class="nx">@source</span><span class="p">.</span><span class="nx">shouldWatch</span>
      </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The file is stamped, which means that its md5 checksum is
calculated and cached. Then the FSWatcher is setup to watch
the file. When a 'rename' event happens, the file has either
been removed or moved -- in both cases, this is sufficient
to trigger a reset. If the event is 'change' we make sure
the file has really change by checking the stamp, then trigger
reset in case it really did change.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@stamp</span><span class="p">()</span>
      <span class="vi">@watcher = </span><span class="nx">fs</span><span class="p">.</span><span class="nx">watch</span> <span class="nx">@fullpath</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">event</span> <span class="o">is</span> <span class="s1">&#39;rename&#39;</span>
          <span class="nx">info</span> <span class="s2">&quot;#{@fullpath} removed&quot;</span>
          <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@liabilities</span>
            <span class="nx">file</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
          
          <span class="nx">setTimeout</span> <span class="nx">reset</span><span class="p">,</span> <span class="mi">50</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">@changed</span><span class="p">()</span>
          <span class="nx">info</span> <span class="s2">&quot;#{@fullpath} changed&quot;</span>
          <span class="nx">reset</span><span class="p">()</span>
      
      <span class="nx">@watcher</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">debug</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span>
        <span class="nx">reset</span><span class="p">()</span>
      
  
  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>This method shuts the watcher if it exists, so no more fs events
are catched.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unwatch: </span><span class="o">-&gt;</span>
    <span class="nx">@watcher</span><span class="o">?</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The stamping method used to cache a md5 checksum of the file on
disk.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">stamp: </span><span class="o">-&gt;</span> <span class="vi">@checksum = </span><span class="nx">util</span><span class="p">.</span><span class="nx">checksumSync</span><span class="p">(</span><span class="nx">@fullpath</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>This method returns whether the file on disk should be considered
changed from the last <code>stamp()</code> method call. It returns false if
no checksum is cached.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">changed: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="nx">unless</span> <span class="p">(</span>
      <span class="nx">@exists</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@checksum</span><span class="o">?</span> <span class="o">and</span>
      <span class="nx">@checksum</span> <span class="o">is</span> <span class="nx">util</span><span class="p">.</span><span class="nx">checksumSync</span><span class="p">(</span><span class="nx">@fullpath</span><span class="p">)</span>
    <span class="p">)</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>Managing <em>dependencies</em></h3>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>This method indicates to the file that it depends on another file.
It takes a file and an actualization function, called when the 
depending file is expired relative to the depended one. Both are 
pushed to a list of dependencies. It also indicates to the other 
file that it is depended upon.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dependOn: </span><span class="nf">(other, actualize) -&gt;</span>
    <span class="nx">@dependencies</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">other</span><span class="p">,</span> <span class="nx">actualize</span><span class="p">]</span>
    <span class="nx">other</span><span class="p">.</span><span class="nx">dependedBy</span> <span class="k">this</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>This method indicates to the file that it is depended by another 
file. This barely adds the file passed as argument to a local list 
of liabilities.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dependedBy: </span><span class="nf">(other) -&gt;</span>
    <span class="nx">@liabilities</span><span class="p">.</span><span class="nx">push</span> <span class="nx">other</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h3>Managing <em>imports</em></h3>

<p>Imports specify what file should precede the current file, should
this file be used in a bundle.</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>This method reads the file and parses it to find <code>import</code>
directives. It can only do this if it is attached to a <em>Source</em>
object, since this source specifies the regular expression used
to find those directives.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readImportedPaths: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@source</span><span class="o">?</span>
      <span class="nv">regexp = </span><span class="nx">@source</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">header</span>
      </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Every chunk that matches the regexp pattern is concatenated
and the result is assumed to be a JSON array of strings,
and returned.</p>

<p><strong>TODO</strong> : Find something better than this.</p>             </td>             <td class="code">               <div class="highlight"><pre>      
      <span class="nv">recurse = </span><span class="nf">(_data) -&gt;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="nx">unless</span> <span class="p">(</span><span class="nv">match = </span><span class="nx">_data</span><span class="p">.</span><span class="nx">match</span> <span class="nx">regexp</span><span class="p">)</span><span class="o">?</span>
        <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">recurse</span> <span class="nx">_data</span><span class="p">[</span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="o">+</span><span class="nx">match</span><span class="p">.</span><span class="nx">index</span> <span class="p">...]</span>
      
      <span class="nv">paths = </span><span class="k">if</span> <span class="p">(</span><span class="nv">json = </span><span class="nx">recurse</span> <span class="nx">@readSync</span><span class="p">()).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">json</span> 
      <span class="k">else</span> <span class="p">[]</span>
      <span class="nv">paths = </span><span class="p">(</span><span class="nx">util</span><span class="p">.</span><span class="nx">changeext</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">paths</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="p">[]</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>This method is used to specify what the imports of this file
should be. It is used, for instance, to carry over imports that
are specified in a .coffee file, to its output .js file, which
would be used in bundles.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setImportedPaths: </span><span class="nf">(paths) -&gt;</span> 
    <span class="vi">@_importedPaths = </span><span class="nx">paths</span>
    <span class="vi">@_imports = </span><span class="kc">null</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>This returns the list of current imports, as a list of relative
(access) path. It first looks for a cached version, reading it
from the file if not found.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">importedPaths: </span><span class="o">-&gt;</span>
    <span class="nx">unless</span> <span class="nx">@_importedPaths</span><span class="o">?</span>
      <span class="vi">@_importedPaths = </span><span class="nx">@readImportedPaths</span><span class="p">()</span>
    <span class="nx">@_importedPaths</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>This returns a list of imports, as a list of <em>File</em> objects. It
first looks for a cached version, making it if not found. It uses
the associated <em>Package</em> object to find those <em>File</em> objects, so
if those files were not initialized, they are still available.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">imports: </span><span class="o">-&gt;</span>
    <span class="nx">unless</span> <span class="nx">@_imports</span><span class="o">?</span>
      <span class="vi">@_imports = </span><span class="p">(</span><span class="nx">@package</span><span class="p">.</span><span class="nx">file</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">@type</span><span class="p">)</span> <span class="k">for</span> <span class="nx">path</span> <span class="k">in</span> <span class="nx">@importedPaths</span><span class="p">())</span>
    <span class="nx">@_imports</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>This method is used to mark the graph of <em>imports</em> (starting at <code>other</code>)
as <em>dependencies</em> on this file. This is used in bundles specifically,
so that changes in any of those imports triggers invalidation of the
bundle.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">dependOnImports: </span><span class="nf">(other, actualize) -&gt;</span>
    <span class="nv">imported = </span><span class="p">[]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>The <em>visiting</em> function. It first checks whether a file has already 
been visited, returning if it has. Then it either crawl the file now,
if it is already attached, or as soon as the file is attached. Then,
it marks the visited file as a dependency and pushes it to the list
of visited files.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">depend = </span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="o">=&gt;</span>                  
      <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">relpath</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">imported</span>
        <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">attached</span><span class="p">()</span>
          <span class="nx">crawl</span> <span class="nx">file</span>
        <span class="k">else</span>
          <span class="nx">file</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;attach&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">crawl</span> <span class="nx">file</span>

        <span class="nx">@dependOn</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">actualize</span>
        <span class="nx">imported</span><span class="p">.</span><span class="nx">push</span> <span class="nx">file</span><span class="p">.</span><span class="nx">relpath</span>
    </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>The <em>crawling</em> function. It barely calls the visiting function on all
imports of the given file.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">crawl = </span><span class="nf">(file) -&gt;</span>
      <span class="nx">depend</span> <span class="nx">_file</span> <span class="k">for</span> <span class="nx">_file</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">imports</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>The method starts with the provided file.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">depend</span> <span class="nx">other</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h4>Topological sorting algorithm</h4>

<p>This method returns a list of imported files, the order of which 
preserves the precedence specified as 'imports'.</p>

<p>This is used to get one of the solution to
topologically sorting a directed acyclic graph.
It is garanteed to find <em>a</em> solution, given the graph
is really acyclic. Here, nodes are files and edges are
imports expressed within it. This is used to bundle files
in an order that will meet precedence requirements. If cycles
are present, the method will silently fail, yielding a 
non-ordered list.</p>

<p><em>Taken from <a href="http://en.wikipedia.org/wiki/Topological_sort#Algorithms">this page on Wikipedia</a></em></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">tsortedImports: </span><span class="o">-&gt;</span>
    <span class="nv">topoSortedFiles = </span><span class="p">[]</span>
    <span class="nv">DAG = </span><span class="p">{}</span>
    <span class="nv">visited = </span><span class="p">[]</span>
    <span class="nv">buildDAG = </span><span class="nf">(file) -&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">file</span><span class="p">.</span><span class="nx">relpath</span> <span class="k">in</span> <span class="nx">visited</span>
      <span class="k">for</span> <span class="nx">n</span> <span class="k">in</span> <span class="nx">file</span><span class="p">.</span><span class="nx">imports</span><span class="p">()</span>
        <span class="nv">edges = </span><span class="nx">DAG</span><span class="p">[</span><span class="nx">n</span><span class="p">.</span><span class="nx">relpath</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]</span>
        <span class="nx">edges</span><span class="p">.</span><span class="nx">push</span> <span class="nx">file</span><span class="p">.</span><span class="nx">relpath</span>
        <span class="nx">buildDAG</span> <span class="nx">n</span>
      <span class="nx">visited</span><span class="p">.</span><span class="nx">push</span> <span class="nx">file</span><span class="p">.</span><span class="nx">relpath</span>
    
    <span class="nx">buildDAG</span> <span class="k">this</span>
    <span class="nv">S = </span><span class="p">[</span><span class="k">this</span><span class="p">]</span>
    <span class="k">while</span> <span class="nx">S</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">n = </span><span class="nx">S</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="nx">topoSortedFiles</span><span class="p">.</span><span class="nx">push</span> <span class="nx">n</span>
      <span class="k">for</span> <span class="nx">m</span> <span class="k">in</span> <span class="nx">n</span><span class="p">.</span><span class="nx">imports</span><span class="p">()</span>
        <span class="nx">DAG</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">relpath</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">without</span> <span class="nx">DAG</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">relpath</span><span class="p">],</span> <span class="nx">n</span><span class="p">.</span><span class="nx">relpath</span>
        <span class="k">if</span> <span class="nx">DAG</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">relpath</span><span class="p">].</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nx">S</span><span class="p">.</span><span class="nx">push</span> <span class="nx">m</span>
    </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>We need it reversed.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">topoSortedFiles</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3>Interacting with the <em>file system</em></h3>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>This method returns whether or not the current file is newer
than the provided one.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">newer: </span><span class="nf">(other) -&gt;</span>
    <span class="nx">util</span><span class="p">.</span><span class="nx">newerSync</span> <span class="nx">@fullpath</span><span class="p">,</span> <span class="nx">other</span><span class="p">.</span><span class="nx">fullpath</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>This method returns whether or not the current file is attached,
which barely means, if it has a fullpath.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">attached: </span><span class="o">-&gt;</span> <span class="nx">@fullpath</span><span class="o">?</span>
  </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>This method returns whether or not the current file exists in
the file system.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exists: </span><span class="o">-&gt;</span> <span class="nx">@attached</span><span class="p">()</span> <span class="o">and</span> <span class="nx">path</span><span class="p">.</span><span class="nx">existsSync</span> <span class="nx">@fullpath</span>
  </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>This method is used to make sure all directories leading to the
full path exist.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makedirs: </span><span class="o">-&gt;</span> <span class="nx">util</span><span class="p">.</span><span class="nx">makedirs</span> <span class="nx">path</span><span class="p">.</span><span class="nx">dirname</span> <span class="nx">@fullpath</span>
  </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>These methods (async and sync) are used to read the content of 
the current file.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">read: </span><span class="nf">(cb) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@exists</span><span class="p">()</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span> <span class="nx">@fullpath</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nf">(err, data) -&gt;</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
  
  <span class="nv">readSync: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@exists</span><span class="p">()</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span> <span class="nx">@fullpath</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>These methods (async and sync) are used to write content to the current file.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">write: </span><span class="nf">(data, cb) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@attached</span><span class="p">()</span>
    <span class="nx">@makedirs</span><span class="p">()</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span> <span class="nx">@fullpath</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nx">cb</span>
  
  <span class="nv">writeSync: </span><span class="nf">(data) -&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@attached</span><span class="p">()</span>
    <span class="nx">@makedirs</span><span class="p">()</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span> <span class="nx">@fullpath</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span>
  
  </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>This method is used to delete the current file.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unlinkSync: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@exists</span><span class="p">()</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">unlinkSync</span> <span class="nx">@fullpath</span>
  </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>This method is used to delete the current file, as well
as all files that depend on it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">destroy: </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">file</span> <span class="k">in</span> <span class="nx">@liabilities</span>
      <span class="nx">file</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
    
    <span class="nx">@unlinkSync</span><span class="p">()</span>
  

<span class="nv">exports.File = </span><span class="nx">File</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 